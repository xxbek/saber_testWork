# План миграции базы и сервисов
-- Для воспроизведения задания локально использовалась СУБД postgresql12 и pgpadmin4
-- Создание тестовой таблицы: create_test_data.sql 
-- План миграции: migration_unique_name.sql

Задача - нормализовать таблицу.
Пусть основная таблица называется NameLog и имеет поля id, name, status, timestamp.
    
Предполагается, что все сервисы типа А или Б будут выключены одномоментно - пока работает хотя бы один сервис следующий пункт не начнется.

1. Прежде всего создается таблица Name, в которой будут хранится уникальные значения поля name из NameLog.
2. Останавливаем сервисы типа А. 
3. Запускаем процедуру, которая сгруппирует уникальные значения для name и вставит их в таблицу Name. 
4. Изменяем логику сервиса типа А: при вставке проверяем, есть ли новое name в множестве уникальных значений из таблицы Name.
Если оно присутствует в таблице, вставляем в NameLog его внешний ключ. Если отсутствует, вставляем уникальное значение в таблицу Name и его ключ в NameLog. 
5. Запускаем сервисы типа А. 
6. Остановливаем сервисы типа Б 
7. Запускаем процедуру, которая заменит все значения поля name в таблице NameLog внешними ключами таблицы Name. 
8. Изменяем имя поля name таблицы NameLog на имя name_id. В этот момент важно, чтобы в логике всех сервисов имя поля также было изменено. 
9. Проставляем ограничение целостности ForeignKey для таблицы NameLog 
10. Изменяем логику сервиса типа А: теперь в запросах на чтение поля name будет INNER JOIN с таблицей Name по полям name_id и id. 
11. Запускаем сервисы типа А.

## Замечания
В промежутке времени между пунктом 4 и 5 возможны случаи, когда оба сервиса работают. 
Возможно то, что сервис А добавит новую запись, используя внешний ключ, а сервис Б прочитает эту запись, не используя ссылку на таблицу уникальных значений.
Тогда возможена отправка нерелевантных данных или сбой в работе системы.
Если выключение сервисов Б будет происходить достаточно быстро и нет условий для быстрого чтения новодобавленных данных, это замечание можно пропустить.



	

